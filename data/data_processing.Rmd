---
title: "Baltimore Public Schools: Girls of Color"
output: html_document
---

Processing steps for girls of color analysis for Baltimore Public Schools

###Load up denominator of data
```{r}
##Set directory
  setwd("~/Documents/Github/cwg_website/data/")

##Libraries
  library(ggmap)
  library(RColorBrewer)
  library(leaflet)

##Load up data
  denom <- read.delim("sc131a-bcpss.txt")
  inc <- read.csv("incidents_2013.csv")
  geocode <- read.csv("bcpss_school-geocoded.csv")
```


##Geocode school data
```{r eval=FALSE}
  geocode <- geocode[,c("NAME.C.254","GRADES.C.254","ADDRESS.C.254","Latitude","Longitude")]
  colnames(geocode) <- c("school","grades","address","lat_orig","lon_orig")
  geocode$lat <- ""
  geocode$lon <- ""
  geocode$geocoder <- "census"
  
  for(i in 1:nrow(geocode)){
    print(i)
    library(rjson)
    library(ggmap)

    ##Address Cleaning
      city <- "Baltimore"
      state <- "MD"
      address<- gsub(" ","+",toupper(sub("[[:punct:]]", "",geocode$address[i])))

  ##Coordinates
    url = paste("http://geocoding.geo.census.gov/geocoder/locations/address?street=",address,"&city=",city,"&state=",state,"&benchmark=9&format=json",sep="")
    document = fromJSON(file=url, method='C')
    if(length(document$result$addressMatches)>0){
    geocode$lon[i] <-  document$result$addressMatches[[1]]$coordinates$x
    geocode$lat[i] <- document$result$addressMatches[[1]]$coordinates$y
    geocode$geocoder[i] <- "Census"
    } else{
      temp <- geocode(paste(toupper(sub("[[:punct:]]", "",geocode$address[i])),", ",city,state))
      if(nrow(temp)>0){
        geocode$lon[i] <-temp$lon[1]
        geocode$lat[i] <-temp$lat[1]
        geocode$geocoder[i] <- "google"
      }
    }
  }

table(is.na(as.numeric(geocode$lat)))
write.csv(geocode,"schools_geocoded.csv",row.names=F)
```

```{r echo=FALSE}
geocode <- read.csv("schools_geocoded.csv")

```
##Denominator: light processing
```{r}
##Denominator from SC131 
  denom <- denom[,c(9,298:320)]
  denom$SCHNAM <- as.character(denom$SCHNAM)
  denom$id <- 1:nrow(denom) ##Assign ID
  for(i in 1:ncol(denom)){ ##Remove missing values under 0
    denom[,i][denom[,i]<0]<-NA
  }
##
```


##Baltimore Incidents: light processing
```{r}
##Incident data from Baltimore Public Schools
  inc <- reshape(inc,
               timevar = "gender",
               idvar = "school",
               direction = "wide")
  inc$SCHNAM <- toupper(inc$school)
  inc$id <- 1:nrow(inc)

```


###Greedy Match Algorithm between Baltimore Public Schools data and SC131a
- Wrote an algorithm to match based on precision of name
- 131 of 132 schools were matched from the BCP data

```{r}
psm <- function(a,b,var,max,min,id){
  
  matched <- data.frame()
  
  for(k in max:min){
    a[,var]<-substr(a[,var],1,k+2)
    b[,var]<-substr(b[,var],1,k+2)
    
    for(j in 1:nrow(a)){
      
      target <- a[j,]
      target <- merge(target,b,by=var)
    
    if(nrow(target)>0){
     # print("if")
      target <- target[1:1,]
      matched<-rbind(matched,cbind(target,k))
      listx <- matched[,paste(id,".x",sep="")]
      listy <- matched[,paste(id,".y",sep="")]
      
      a <- a[ !a[,id] %in% listx, ]
      b <- b[ !b[,id] %in% listy, ]
      
    }
    
    rm(target)
    }
  }
  return(matched)
}
```

131 of 132 schools matched.

```{r}
  result <- psm(inc,denom,"SCHNAM",50,4,"id")
```

###Incident rates by race
```{r}
result$pct_aframerf  <- result$inc_aframer.Female/(result$BLALF)
result$pct_amerind  <- result$inc_amerind.Female/result$AMALF
result$pct_aapi  <- result$inc_asian.Female/(result$ASALF+result$HPALF)
result$pct_hisp  <- result$inc_hisp.Female/result$HIALF
result$pct_white <- result$inc_white.Female/result$WHALF

for(i in (ncol(result)-4):ncol(result)){
  print(colnames(result)[i])
  result[,i][result[,i]==Inf]<-NA
  print(summary(result[,i]))
}

```


###Race share of females in school
```{r}
result$total_female <- (result$BLALF +result$AMALF +result$ASALF+result$HPALF +result$HIALF + result$WHALF)
result$share_aframerf  <- result$BLALF/result$total_female
result$share_amerind  <- result$AMALF/result$total_female
result$share_aapi  <- (result$ASALF+result$HPALF )/(result$total_female)
result$share_hisp  <- result$HIALF/result$total_female
result$share_white <- result$WHALF/result$total_female
```


###Incident share of females in school
```{r}
result$totalinc_female <- (result$inc_aframer.Female +result$inc_amerind.Female +result$inc_asian.Female +result$inc_hisp.Female+result$inc_white.Female)
result$shareinc_aframerf  <- result$inc_aframer.Female/result$totalinc_female
result$shareinc_amerind  <- result$inc_amerind.Female/result$totalinc_female
result$shareinc_aapi  <- result$inc_asian.Female/(result$totalinc_female)
result$shareinc_hisp  <- result$inc_hisp.Female/result$totalinc_female
result$shareinc_white <- result$inc_white.Female/result$totalinc_female


###Join up coordinates
```{r}
  geocode$school_upper<-toupper(geocode$school)
  result$school_upper <- toupper(result$school)
  result <- psm(result,geocode,"school_upper",50,4,"school")
  print(paste("Total data in sample: ",nrow(inc)))
  print(paste("Total matched between geocode and incidents ",nrow(result)," ~ ",round(100*nrow(result)/nrow(inc),2),"%"),sep="")
```


```{r}
overall_pr <- data.frame(data = c(result$pct_aframerf,result$pct_hisp,result$pct_aapi,result$pct_white,result$pct_amerind))
overall_pr <- overall_pr[!is.na(overall_pr[,1]) & 
                          overall_pr[,1] >= quantile(overall_pr[,1],0.025, na.rm=T)
                         & overall_pr[,1] <= quantile(overall_pr[,1],0.975, na.rm=T),]



#African Americans
  pr <- round(result$pct_aframerf,2)
  x_all <-as.numeric(result$lon)
  y_all <- as.numeric(result$lat)
  school <- result$school.x
  grades <- result$grades 
  share <- round(100*result$share_aframerf,2)
  inc_cnt <- result$inc_aframer.Female
  sb_cnt <- result$BLALF

#Hispanics
  pr_hisp <- round(result$pct_hisp,2)
  share_hisp <- round(100*result$share_hisp,2)

#White
  pr_white <- round(result$pct_white,2)
  share_white <- round(100*result$share_white,2)

  content_aframer <- paste0("<h3>",school,"</h3>
                            <hr><p><strong>Statistics for Female African American Students </strong><br>
                            <u>Student Body</u>:  <span style='color:red'>  ","<strong> ",sb_cnt,"</strong></span> of ",sb_cnt," (",share,"%)<br>
                            <u>Incidents (Total)</u>: <span style='color:red'> ","<strong> ",inc_cnt,"</strong></span> of ",inc_cnt," (",inc_cnt,") <br> 
                            <u>Incidents (per pupil)</u>:  <span style='color:red'>  ","<strong> ",pr,"</strong></span><br><br>
                            <strong>School Characteristics </strong><br>
                            <u>Grades</u>: ",grades," 
                            </p>")

  content_hisp <- paste0("<h3><strong>",school,"</strong></h3><b<p><u>Race</u>:  Hispanic <br><u>Grades</u>: ",grades," <br> <u>Incidents per student</u>:  <span style='color:red'>  ","<strong> ",pr_hisp,"</strong></span><br><u>% of student body</u>: ",share_hisp,"%</p>")
  content_white <- paste0("<h3><strong>",school,"</strong></h3><p><u>Race</u>: White <br><u>Grades</u>: ",grades," <br> <u>Incidents per student</u>:  <span style='color:red'>  ","<strong> ",pr_white,"</strong></span><br><u>% of student body</u>: ",share_white,"%</p>")

pal <- colorNumeric(
  palette = "Reds",
  domain = pr
)
pal_hisp <- colorNumeric(
  palette = "Blues",
  domain = pr_hisp
)
pal_white<- colorNumeric(
  palette = "Greens",
  domain = pr_white
)

```

###The Maps
To start, we'll initialize a leaflet.js map.

```{r}

leaflet(width="100%") %>% 
  setView(lat = mean(y_all), lng = mean(x_all),12) %>%
  addTiles('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
             attribution = "Something goes here") %>% 
  addCircleMarkers(data = result, lat = ~ lat, lng = ~ lon,radius=(result$inc_aframer.Female)/4, 
                   fillOpacity = 0.8,stroke = FALSE, 
                   color = ~pal(pr), popup = content_aframer, group="African Americans") %>% 
  addCircleMarkers(data = result, lat = ~ lat, lng = ~ lon,radius=(result$inc_hisp.Female)/4, 
                   fillOpacity = 0.8,stroke = FALSE, 
                   color = ~pal_hisp(pr_hisp), popup = content_hisp, group="Hispanics") %>%
   addCircleMarkers(data = result, lat = ~ lat, lng = ~ lon,radius=(result$inc_white.Female)/4, 
                   fillOpacity = 0.8,stroke = FALSE, 
                   color = ~pal_white(pr_white), popup = content_white, group="Whites") %>% 
  addLayersControl(
    overlayGroups = c("African Americans","Hispanics","Whites"),
    options = layersControlOptions(collapsed = FALSE)
  )
  
```
